<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…ØµØ­Ù Ø§Ù„Ù…Ø±ÙˆØ¬ - Ø§Ù„Ø­Ù„ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@700&family=Tajawal:wght@500;800&display=swap" rel="stylesheet">
    <style>
        :root { --dark-gold: #3d3107; --gold: #d4af37; --om-green: #032a1d; --bg: #fdfaf1; }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); font-family: 'Tajawal', sans-serif; height: 100vh; overflow: hidden; color: var(--om-green); }

        /* Ø´Ø§Ø´Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ */
        #splash-screen { position: fixed; inset: 0; background: var(--om-green); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 20000; transition: 0.8s; }
        #splash-screen img { width: 120px; height: 120px; border-radius: 20px; border: 3px solid var(--gold); margin-bottom: 20px; }
        #splash-screen h1 { color: var(--gold); font-family: 'Amiri'; font-size: 2.2rem; }
        .loader { width: 40px; height: 40px; border: 3px solid rgba(212, 175, 55, 0.2); border-top-color: var(--gold); border-radius: 50%; animation: spin 1s linear infinite; margin-top: 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Ø§Ù„Ù‡ÙŠØ¯Ø± */
        header { background: var(--om-green); padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid var(--gold); }
        .logo { display: flex; align-items: center; gap: 10px; }
        .logo img { width: 45px; height: 45px; border-radius: 8px; border: 1px solid var(--gold); background: #fff; }
        
        main { height: calc(100vh - 145px); overflow-y: auto; padding: 15px; padding-bottom: 120px; }
        .challenge-box { background: var(--dark-gold); color: white; border-radius: 12px; padding: 15px; margin-bottom: 20px; border: 1px solid var(--gold); display: flex; justify-content: space-between; align-items: center; }
        
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { flex: 1; padding: 10px; border-radius: 25px; border: 2px solid var(--gold); background: #fff; font-weight: 800; cursor: pointer; }
        .tab-btn.active { background: var(--gold); color: #000; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
        .card { background: #fff; border: 2px solid var(--gold); border-radius: 10px; padding: 20px 10px; text-align: center; cursor: pointer; }
        .card h3 { font-family: 'Amiri'; font-size: 1.5rem; color: var(--om-green); }

        /* Ù…Ø´ØºÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…Ø·ÙˆØ± */
        .player { position: fixed; inset: 0; background: #000; z-index: 9999; display: none; flex-direction: column; justify-content: center; }
        .v-container { width: 100%; position: relative; padding-top: 56.25%; background: #000; }
        .v-container iframe, .v-container video { position: absolute; top:0; left:0; width:100%; height:100%; border:none; }
        .close-v { position: absolute; top: 20px; right: 20px; background: var(--gold); border: none; width: 40px; height: 40px; border-radius: 50%; font-weight: bold; z-index: 10000; cursor: pointer; }
        
        #success-msg { position: fixed; top: -70px; left: 0; width: 100%; background: var(--gold); padding: 15px; text-align: center; font-weight: 900; transition: 0.5s; z-index: 10001; }
        #success-msg.show { top: 0; }

        /* Ø§Ù„Ù…ÙˆØ¯Ø§Ù„Ø§Øª */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 10002; }
        .m-card { background: var(--om-green); border: 2px solid var(--gold); width: 85%; max-width: 350px; border-radius: 15px; padding: 20px; text-align: center; color: white; }
        .g-btn { width: 100%; padding: 10px; margin-bottom: 8px; border-radius: 8px; border: 1px solid var(--gold); background: rgba(255,255,255,0.1); color: #fff; font-weight: bold; cursor: pointer; }
        .close-m { background: var(--gold); color: #000; border: none; padding: 10px; width: 100%; border-radius: 8px; margin-top: 15px; font-weight: 900; }

        /* Ø§Ù„Ù†Ø§Ù Ø¨Ø§Ø± */
        nav { position: fixed; bottom: 0; width: 100%; background: var(--om-green); display: flex; padding: 10px 0 25px; border-top: 2px solid var(--gold); }
        .nav-btn { flex: 1; border: none; background: none; color: #8a9b94; text-align: center; font-size: 0.7rem; font-weight: bold; display: flex; flex-direction: column; align-items: center; gap: 5px; cursor: pointer; }
        .nav-btn.active { color: var(--gold); }
    </style>
</head>
<body>

<div id="splash-screen">
    <img src="https://raw.githubusercontent.com/faissaltunisia/student-grades/main/Screenshot%202025-12-16%20235912.png">
    <h1>Ù…ÙØµØ­ÙÙ Ø§Ù„Ù…ÙØ±ÙÙˆØ¬</h1>
    <div class="loader"></div>
</div>

<div id="success-msg">ğŸ† Ù…Ø¨Ø§Ø±Ùƒ! ØªÙ… Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„ØªØ­Ø¯ÙŠ Ø§Ù„ÙŠÙˆÙ…ÙŠ Ø¨Ù†Ø¬Ø§Ø­</div>

<header>
    <div class="logo">
        <img src="https://raw.githubusercontent.com/faissaltunisia/student-grades/main/Screenshot%202025-12-16%20235912.png">
        <h1 style="color:var(--gold); font-family:'Amiri'; font-size:1.4rem;">Ù…ØµØ­Ù Ø§Ù„Ù…Ø±ÙˆØ¬</h1>
    </div>
    <span id="cur-g" style="color:#fff; font-size:0.7rem; border:1px solid var(--gold); padding:4px 8px; border-radius:5px;"></span>
</header>

<main>
    <div class="challenge-box">
        <div><p style="font-size:0.7rem;">ØªØ­Ø¯ÙŠ Ø§Ù„ÙŠÙˆÙ… âš¡</p><h2 id="ch-name" style="font-family:'Amiri';">--</h2></div>
        <button onclick="startChallenge()" style="background:var(--gold); border:none; padding:8px 15px; border-radius:8px; font-weight:900; cursor:pointer;">Ø§Ø¨Ø¯Ø£</button>
    </div>
    <div class="tabs">
        <button id="t1" class="tab-btn active" onclick="setSem(1)">Ø§Ù„ÙØµÙ„ 1</button>
        <button id="t2" class="tab-btn" onclick="setSem(2)">Ø§Ù„ÙØµÙ„ 2</button>
    </div>
    <div id="surah-grid" class="grid"></div>
</main>

<div id="player" class="player">
    <button class="close-v" onclick="closeP()">âœ•</button>
    <div class="v-container" id="v-box"></div>
    <div id="lock-tip" style="color:var(--gold); text-align:center; padding:15px; font-size:0.8rem;"></div>
</div>

<nav>
    <button class="nav-btn active" onclick="location.reload()"><span>ğŸ </span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
    <button class="nav-btn" onclick="openM('modal-g')"><span>ğŸ“‚</span>Ø§Ù„ØµÙÙˆÙ</button>
    <button class="nav-btn" onclick="openM('modal-p')"><span>ğŸ</span>Ø§Ù„Ø¬Ø§Ø¦Ø²Ø©</button>
    <button class="nav-btn" onclick="openM('modal-info')"><span>â„¹ï¸</span>Ø§Ù„Ù…Ù†ØµØ©</button>
</nav>

<div id="modal-g" class="modal"><div class="m-card">
    <h3 style="color:var(--gold); margin-bottom:15px;">Ø§Ø®ØªØ± ØµÙÙƒ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</h3>
    <div id="g-list" style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;"></div>
    <button class="close-m" onclick="closeM('modal-g')">Ø¥ØºÙ„Ø§Ù‚</button>
</div></div>

<div id="modal-p" class="modal"><div class="m-card"><div id="p-content"></div><button class="close-m" onclick="closeM('modal-p')">Ø¹ÙˆØ¯Ø©</button></div></div>

<div id="modal-info" class="modal"><div class="m-card">
    <h2 style="color:var(--gold); font-family:'Amiri';">Ù…ØµØ­Ù Ø§Ù„Ù…Ø±ÙˆØ¬</h2>
    <p style="margin:15px 0; font-size:0.9rem;">Ø¨Ø¥Ø´Ø±Ø§Ù Ø§Ù„Ø£Ø³ØªØ§Ø° ÙÙŠØµÙ„ Ø§Ù„Ø¹Ø±ÙŠØ¨ÙŠ</p>
    <button class="close-m" onclick="closeM('modal-info')">ÙÙ‡Ù…Øª</button>
</div></div>

<script>
    const SB_URL = 'https://vchzkeebmjqiohgoknnm.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZjaHprZWVibWpxaW9oZ29rbm5tIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxMzU3MjgsImV4cCI6MjA4MTcxMTcyOH0.bDIOdzhpj5M_5Hx7_SdnaBulImmFG41OKIOQGnx7FHI';
    const _sb = supabase.createClient(SB_URL, SB_KEY);

    let all = [], grade = "Ø§Ù„ØµÙ Ø§Ù„Ø®Ø§Ù…Ø³", sem = 1, today = null, won = false, lastT = 0, isCh = false, vRef = null;
    const grades = ["Ø§Ù„ØµÙ Ø§Ù„Ø®Ø§Ù…Ø³", "Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³", "Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¨Ø¹", "Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù…Ù†", "Ø§Ù„ØµÙ Ø§Ù„ØªØ§Ø³Ø¹", "Ø§Ù„ØµÙ Ø§Ù„Ø¹Ø§Ø´Ø±", "Ø§Ù„ØµÙ Ø§Ù„Ø­Ø§Ø¯ÙŠ Ø¹Ø´Ø±", "Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø¹Ø´Ø±"];

    window.onload = () => { setTimeout(() => { document.getElementById('splash-screen').style.opacity = '0'; setTimeout(() => document.getElementById('splash-screen').style.display = 'none', 800); }, 2500); init(); };

    async function init() {
        const { data } = await _sb.from('surahs').select('*');
        all = data || [];
        document.getElementById('g-list').innerHTML = grades.map(g => `<button class="g-btn" onclick="setGrade('${g}')">${g}</button>`).join('');
        render();
        if(localStorage.getItem('win_'+new Date().toDateString())) won = true;
    }

    function setGrade(g) { grade = g; closeM('modal-g'); render(); }
    function setSem(s) { sem = s; document.getElementById('t1').className = s==1?'tab-btn active':'tab-btn'; document.getElementById('t2').className = s==2?'tab-btn active':'tab-btn'; render(); }

    function render() {
        const filtered = all.filter(s => s.grade === grade && s.semester == sem);
        document.getElementById('surah-grid').innerHTML = filtered.map(s => `
            <div class="card" onclick="play('${s.video_path}', '${s.title}', false)">
                <h3>${s.title}</h3>
                <p style="font-size:0.6rem; color:#aaa; margin-top:5px;">Ù…Ø´Ø§Ù‡Ø¯Ø© Ù…ÙØªÙˆØ­Ø© âœ…</p>
            </div>`).join('');
        if(filtered.length) { today = filtered[new Date().getDate() % filtered.length]; document.getElementById('ch-name').innerText = today.title; }
        document.getElementById('cur-g').innerText = grade;
    }

    function play(url, title, ch) {
        isCh = ch; lastT = 0;
        document.getElementById('player').style.display = 'flex';
        document.getElementById('lock-tip').innerText = ch ? "ğŸ”’ ÙˆØ¶Ø¹ Ø§Ù„ØªØ­Ø¯ÙŠ: Ø§Ù„ØªÙ‚Ø¯ÙŠÙ… Ù…Ø¹Ø·Ù„" : "âœ… Ù…Ø´Ø§Ù‡Ø¯Ø© Ø¹Ø§Ø¯ÙŠØ©: Ø§Ù„ØªØ­ÙƒÙ… Ù…ØªØ§Ø­";
        const box = document.getElementById('v-box'); box.innerHTML = "";
        
        if(url.includes('youtube') || url.includes('youtu.be')) {
            let id = url.includes('v=') ? url.split('v=')[1].split('&')[0] : url.split('/').pop();
            // Ø§Ù„Ø­Ù„ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ Ù„Ù„ÙŠÙˆØªÙŠÙˆØ¨: Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù€ API Ø§Ù„Ù…Ø¨Ø³Ø·Ø© Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¹Ù…Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ù‡ÙˆØ§ØªÙ
            box.innerHTML = `<iframe src="https://www.youtube.com/embed/${id}?autoplay=1&controls=${ch?0:1}&modestbranding=1&rel=0&playsinline=1" allow="autoplay; fullscreen"></iframe>`;
            if(ch) { let p=0; window.timer = setInterval(()=>{p++; if(p>=75 && !won) doWin();}, 1000); }
        } else {
            // Ø§Ù„Ø­Ù„ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ Ù„Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©
            const v = document.createElement('video');
            v.src = url;
            v.controls = !ch;
            v.autoplay = true;
            v.setAttribute('playsinline', '');
            v.setAttribute('webkit-playsinline', '');
            box.appendChild(v);
            vRef = v;
            v.ontimeupdate = () => {
                if(isCh) {
                    if(v.currentTime > lastT + 1.5) v.currentTime = lastT; else lastT = v.currentTime;
                    if((v.currentTime/v.duration) > 0.75 && !won) doWin();
                }
            };
        }
    }

    function doWin() { won = true; localStorage.setItem('win_'+new Date().toDateString(), 'true'); document.getElementById('success-msg').classList.add('show'); setTimeout(()=>document.getElementById('success-msg').classList.remove('show'), 4000); }
    function closeP() { if(vRef){vRef.pause(); vRef=null;} document.getElementById('v-box').innerHTML=""; clearInterval(window.timer); document.getElementById('player').style.display='none'; }
    function startChallenge() { if(today) play(today.video_path, today.title, true); }
    function openM(id) { 
        if(id==='modal-p') document.getElementById('p-content').innerHTML = won ? `<h1>ğŸ</h1><h2>Ø£Ø­Ø³Ù†Øª!</h2><p>ØªÙ… ÙØªØ­ Ø§Ù„Ø¬Ø§Ø¦Ø²Ø©.</p>` : `<h1>ğŸ”’</h1><p>Ø£ÙƒÙ…Ù„ Ø§Ù„ØªØ­Ø¯ÙŠ Ø£ÙˆÙ„Ø§Ù‹.</p>`;
        document.getElementById(id).style.display = 'flex'; 
    }
    function closeM(id) { document.getElementById(id).style.display = 'none'; }
</script>
</body>
</html>
